# Base runtime image for running the app
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
USER $APP_UID
EXPOSE 8080
EXPOSE 8081

# Build and publish the application
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src

# Copy only csproj files first â€” improves restore caching
COPY ["Sonar/Sonar.csproj", "Sonar/"]
COPY ["Application/Application.csproj", "Application/"]
COPY ["Entities/Entities.csproj", "Entities/"]
COPY ["Infrastructure/Infrastructure.csproj", "Infrastructure/"]

# Run restore once
RUN dotnet restore "Sonar/Sonar.csproj"

# Now copy the full source
COPY . .
WORKDIR "/src/Sonar"

# Directly publish, without separate build and without a second restore
RUN dotnet publish "Sonar.csproj" \
    -c $BUILD_CONFIGURATION \
    -o /app/publish \
    /p:UseAppHost=false \
    --no-restore

# Final image for production
FROM base AS final
WORKDIR /app
COPY --from=build /app/publish .
VOLUME ["/app/data"]
ENTRYPOINT ["dotnet", "Sonar.dll"]
